<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
  // Script to run once loaded
  $(function() {
    $('#select-sheet').change(changeSheet);
    $('#button-sheet-current').click(useCurrentSheet);

    $('#button-update-objective').click(updateObjective);
    $('#button-clear-objective').click(deleteObjective);

    $('input[type=radio][name=objective-sense]').change(updateObjectiveSense);
    $('#text-objective-sense-target-value').change(updateObjectiveTarget);

    $('#button-add-variable').click(addVariable);
    $('#button-update-variable').click(updateVariable);
    $('#button-delete-variable').click(deleteVariable);

    $('#button-save-constraint').click(saveConstraint);
    $('#button-delete-constraint').click(deleteConstraint);
    $('#button-cancel-constraint').click(cancelConstraintChange);

    $('#button-edit-constraint-lhs').click(editConstraintLHS);
    $('#select-constraint-rel').change(changeConstraintREL);
    $('#button-edit-constraint-rhs').click(editConstraintRHS);

    $('#select-variable-cells').change(updateVariableButtons);

    $('#select-constraint-cells').change(changeSelectedConstraint);

    $('#checkbox-non-negative').change(updateAssumeNonNeg);

    $('#button-solve').click(solveModel);
    $('#button-reset').click(resetModel);
    $('#checkbox-show-status').change(updateShowStatus);
    $('#checkbox-check-linear').change(updateCheckLinear);

    loadSidebar();
  });

  var curLHS;
  var curREL;
  var curRHS;
  var curSheetId;
  var curEscapedSheetName;

  /**
   * Inserts a div that contains an error message after a given element.
   *
   * @param msg The error message to display.
   * @param element The element after which to display the error.
   */
  function showError(msg, element) {
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
  }

  function useCurrentSheet() {
    curSheetId = null;
    loadSidebar();
  }

  function populateSheetSelect(sheets) {
    var sheetSelect = $('#select-sheet');
    sheetSelect.find('option').remove();
    for (var i = 0; i < sheets.length; i++) {
      var option = new Option(sheets[i].name, sheets[i].id);
      sheetSelect.append($(option));
    }
  }

  function selectSheet(sheetIndex) {
    $('#select-sheet').prop('selectedIndex', sheetIndex);
    curSheetId = parseInt($('#select-sheet option:selected').val(), 10);
  }

  function changeSheet() {
    var selectedSheetId = parseInt($('#select-sheet option:selected').val(), 10);
    if (curSheetId !== selectedSheetId) {
      curSheetId = selectedSheetId;
      loadSidebar();
    }
  }

  function updateObjective() {
    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .updateObjective(curSheetId);
  }

  function deleteObjective() {
    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .deleteObjective(curSheetId);
  }

  function updateObjectiveSense() {
    var objSense = parseInt($('input[type=radio][name=objective-sense]:checked').val(), 10);
    enableObjectiveTarget();
    google.script.run.updateObjectiveSense(objSense, curSheetId);
  }

  function enableObjectiveTarget() {
    var objSense = parseInt($('input[type=radio][name=objective-sense]:checked').val(), 10);
    $('#text-objective-sense-target-value').prop('disabled', objSense != 3);
  }

  function updateObjectiveTarget() {
    var objVal = parseFloat($('#text-objective-sense-target-value').val(), 10);
    google.script.run.updateObjectiveTarget(objVal, curSheetId);
  }

  function addVariable() {
    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .addVariable(curSheetId);
  }

  function updateVariable() {
    showWait();
    var index = $('#select-variable-cells').prop('selectedIndex');
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .updateVariable(index, curSheetId);
  }

  function deleteVariable() {
    showWait();
    var index = getSelectedIndexFromList($('#select-variable-cells'));
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .deleteVariable(index, curSheetId);
  }

  function updateVariableButtons() {
    var disable = $('#select-variable-cells option:selected').length === 0;
    $('#button-update-variable, #button-delete-variable').prop('disabled', disable);
  }

  function updateAssumeNonNeg() {
    var nonNeg = $('#checkbox-non-negative').prop('checked');
    google.script.run.updateAssumeNonNeg(nonNeg, curSheetId);
  }

  function editConstraintLHS() {
    editConstraint($('#text-constraint-lhs'));
  }

  function editConstraintRHS() {
    editConstraint($('#text-constraint-rhs'));
  }

  function changeConstraintREL() {
    enableUi();
  }

  function changeSelectedConstraint() {
    var selected = $('#select-constraint-cells').prop('selectedIndex');
    if (selected === 0) {
      curLHS = '';
      curREL = 0;
      curRHS = '';
    } else {
      var values = $('#select-constraint-cells option:selected').val().split(';');
      curLHS = values[0];
      curREL = parseInt(values[1]);
      curRHS = values[2];
    }
    $('#text-constraint-lhs').val(curLHS);
    $('#select-constraint-rel').val(curREL);
    if (curREL >= 4) {
      curRHS = '';
    }
    $('#text-constraint-rhs').val(curRHS);
    changeConstraintREL();
    enableUi();
  }

  function editConstraint($textElem) {
    showWait();
    google.script.run
        .withFailureHandler(hideWait)
        .withSuccessHandler(
          function(range, element) {
            $textElem.val(range);
            enableUi();
            hideWait();
          })
        .getSelectedRangeNotation();
  }

  function saveConstraint() {
    var index = getSelectedIndexFromList($('#select-constraint-cells'))  - 1;
    var lhs = $('#text-constraint-lhs').val();
    var rel = parseInt($('#select-constraint-rel option:selected').val(), 10);
    var rhs = $('#text-constraint-rhs').val();

    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .saveConstraint(lhs, rhs, rel, index, curSheetId);
  }

  function deleteConstraint() {
    showWait();
    var index = getSelectedIndexFromList($('#select-constraint-cells')) - 1;
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .deleteConstraint(index, curSheetId);
  }

  function cancelConstraintChange() {
    changeSelectedConstraint();
  }

  function getSelectedIndexFromList(selectElem) {
    return selectElem.prop('selectedIndex');
  }

  function removeItemFromList(selectElem, index) {
    var length = selectElem.children('option').length;
    if (index < 0 || index > length) {
      return;
    }

    selectElem.children('option')[index].remove();
    length -= 1;

    if (length <= index) {
      selectElem.prop('selectedIndex', length - 1);
    } else {
      selectElem.prop('selectedIndex', index);
    }
  }

  function removeCurrentSheetName(range) {
    var searchString = curEscapedSheetName + '!';
    if (range.indexOf(searchString) === 0) {
      return range.substr(searchString.length);
    }
    return range;
  }

  function checkConstraintChanged() {
    var lhs = $('#text-constraint-lhs').val();
    var rel = parseInt($('#select-constraint-rel option:selected').val(), 10);
    var rhs = $('#text-constraint-rhs').val();
    return !((removeCurrentSheetName(lhs) === curLHS) &&
             (rel === curREL || 0 === curREL) &&
             (removeCurrentSheetName(rhs) === curRHS));
  }

  function enableUi(disableAll) {
    disableAll = disableAll ? true : false;
    var changed = checkConstraintChanged();

    $('#button-save-constraint, #button-cancel-constraint').prop('disabled', !changed || disableAll);

    $('#select-sheet, #button-sheet-current, ' +
      '#button-update-objective, #button-clear-objective, input[type=radio][name=objective-sense], #text-objective-sense-target-value, ' +
      '#select-variable-cells, #button-add-variable, #button-update-variable, #button-delete-variable, ' +
      '#checkbox-non-negative, #select-constraint-cells, #button-solve, #button-reset, #checkbox-show-status, #checkbox-check-linear')
        .prop('disabled', changed || disableAll);

    var disableRHS = $('#select-constraint-rel').val() >= 4;
    if (disableRHS || disableAll) {
      $('#text-constraint-rhs').removeClass('text-range');
    } else {
      $('#text-constraint-rhs').addClass('text-range');
    }
    if (disableAll) {
      $('#text-constraint-lhs').removeClass('text-range');
    } else {
      $('#text-constraint-lhs').addClass('text-range');
    }

    $('#button-edit-constraint-rhs').prop('disabled', disableRHS || disableAll);
    $('#select-constraint-rel, #button-edit-constraint-lhs').prop('disabled', disableAll);


    var selected = $('#select-constraint-cells').prop('selectedIndex');
    $('#button-delete-constraint').prop('disabled', (selected === 0) || disableAll);

    if (changed || disableAll) {
      $('#text-objective-cell').removeClass('text-range');
    } else {
      $('#text-objective-cell').addClass('text-range');
      enableObjectiveTarget();
      updateVariableButtons();
    }

  }

  function loadSidebar() {
    // Reset any selections in the lists
    $('#select-constraint-cells').prop('selectedIndex', -1);
    $('#select-variable-cells').prop('selectedIndex', -1);

    showWait();
    google.script.run
        .withFailureHandler(hideWait)
        .withSuccessHandler(
          function(data, element) {
            console.log(JSON.stringify(data));
            curEscapedSheetName = data.escapedSheetName;
            populateSheetSelect(data.sheets);
            selectSheet(data.sheetIndex);
            loadModel(data.model);
          })
        .getSidebarData(curSheetId);

  }

  function solveModel() {
    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(hideWait)
      .solveModel(curSheetId);
  }

  function resetModel() {
    showWait();
    google.script.run
      .withFailureHandler(hideWait)
      .withSuccessHandler(loadModel)
      .clearModel(curSheetId);
  }

  function updateShowStatus() {
    var showStatus = $('#checkbox-show-status').prop('checked');
    google.script.run.updateShowStatus(showStatus, curSheetId);
  }

  function updateCheckLinear() {
    var checkLinear = $('#checkbox-check-linear').prop('checked');
    google.script.run.updateCheckLinear(checkLinear, curSheetId);
  }

  function showWait() {
    $('#main').addClass('wait');
    enableUi(true);
  }

  function hideWait() {
    $('#main').removeClass('wait');
    enableUi();
  }

  function loadModel(model) {
    var $selectConstraints = $('#select-constraint-cells');
    var currentIndex = getSelectedIndexFromList($selectConstraints);
    var defaultOption = new Option('<Add new constraint>', 0);
    $selectConstraints.find('option').remove().end().append(defaultOption);
    for (var i = 0; i < model.constraints.length; i++) {
      var option = new Option(model.constraints[i].text, model.constraints[i].value);
      $selectConstraints.append($(option));
    }
    var newIndex = Math.min(Math.max(currentIndex, 0),
                            $selectConstraints.find('option').length - 1);
    $selectConstraints.prop('selectedIndex', newIndex);
    changeSelectedConstraint();

    var $selectVariables = $('#select-variable-cells') || 0;
    var currentIndex = getSelectedIndexFromList($selectVariables);
    $selectVariables.find('option').remove();
    for (var i = 0; i < model.variables.length; i++) {
      var option = new Option(model.variables[i], model.variables[i]);
      $selectVariables.append($(option));
    }
    var newIndex = Math.min(currentIndex,
                            $selectVariables.find('option').length - 1);
    $selectVariables.prop('selectedIndex', newIndex);

    $('#text-objective-cell').val(model.objective);
    if (model.objectiveSense) {
      $('input[type=radio][name=objective-sense]').val([model.objectiveSense]);
    }
    $('#text-objective-sense-target-value').val(model.objectiveVal);
    $('#text-objective-sense-target-value').prop('disabled', model.disableVal);

    $('#checkbox-non-negative').prop('checked', model.assumeNonNeg);
    $('#checkbox-show-status').prop('checked', model.showStatus);
    $('#checkbox-check-linear').prop('checked', model.checkLinear);

    hideWait();
  }
</script>
